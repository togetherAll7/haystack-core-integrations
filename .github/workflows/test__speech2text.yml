# SPDX-FileCopyrightText: 2022-present deepset GmbH <info@deepset.ai>
#
# SPDX-License-Identifier: Apache-2.0
name: Test speech2text

on:
  push:
    paths:
      - 'nodes/speech2text/**'
      - '.github/workflows/test__speech2text.yml'

env:
  PACKAGE: nodes/speech2text/
  MODULE: speech2text
  PYTEST_PARAMS: --maxfail=5 --durations=10

jobs:

  mypy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Setup Python
      uses: ./.github/actions/python_cache/
      with:
        package: ${{ env.PACKAGE }}

    - name: Install audio libraries
      if: matrix.os == "ubuntu-latest"
      run: |
        sudo apt-get update
        sudo apt-get install libsndfile1 ffmpeg

    - name: Install dependencies
      run: pip install ${{ env.PACKAGE }}[dev]

    - name: Mypy
      if: steps.files.outputs.any_changed == 'true'
      run: |
        mkdir .mypy_cache/
        mypy --install-types --non-interactive .


  pylint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Setup Python
      uses: ./.github/actions/python_cache/
      with:
        package: ${{ env.PACKAGE }}

    - name: Pylint
      run: |
        cd ${{ env.PACKAGE }}
        pylint -ry -j 0 ${{ env.MODULE }}/


  unit-tests:
    name: Unit / ${{ matrix.os }}
    needs:
      - mypy
      - pylint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]  # windows-latest --> No audio deps available for Windows.
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v2

      - name: Setup Python
        uses: ./.github/actions/python_cache/
        with:
          package: ${{ env.PACKAGE }}

      - name: Install audio libraries
        run: |
          sudo apt-get update
          sudo apt-get install libsndfile1 ffmpeg

      - name: Install Haystack
        run: |
          pip install ${{ env.PACKAGE }}[dev]
          pip install git+https://github.com/openai/whisper.git

      - name: Run
        run: pytest ${{ env.PYTEST_PARAMS }} -m "unit" ${{ env.PACKAGE }}


  integration-tests:
    name: Integration / ${{ matrix.os }}
    needs:
      - unit-tests
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]  # windows-latest --> No audio deps available for Windows.
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v2

    - name: Setup Python
      uses: ./.github/actions/python_cache/
      with:
        package: ${{ env.PACKAGE }}

    - name: Install audio libraries
      run: |
        sudo apt-get update
        sudo apt-get install libsndfile1 ffmpeg

    - name: Install Haystack
      run: |
        pip install ${{ env.PACKAGE }}[dev]
        pip install git+https://github.com/openai/whisper.git

    - name: Run tests
      env:
        TOKENIZERS_PARALLELISM: 'false'  # Avoid logspam by tokenizers
      run: |
        pytest ${{ env.PYTEST_PARAMS }} -m "integration" ${{ env.PACKAGE }}
